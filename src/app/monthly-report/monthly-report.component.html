<div class="monthly-report-container">
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">Report Mensile</h1>
    </div>
  </header>

  <section
    class="month-selection-card feature-card"
    aria-labelledby="month-selection-heading"
  >
    <div class="selection-header">
      <h3 id="month-selection-heading">Selezione Mese</h3>
      <p>Scegli il mese di riferimento per la compilazione</p>
    </div>
    <div class="selection-controls">
      <div class="form-group">
        <label for="month-select">Mese di riferimento:</label>
        <input
          id="month-select"
          type="month"
          [value]="getFormattedMonth()"
          (change)="onMonthChange($event)"
          class="form-control"
          aria-describedby="month-help"
        />
      </div>
      <div class="form-group">
        <label for="employee-name">Nome dipendente:</label>
        <input
          id="employee-name"
          type="text"
          class="form-control"
          [ngModel]="employeeName()"
          (ngModelChange)="onEmployeeNameChange($event)"
          placeholder="Inserisci nome e cognome"
          aria-label="Nome dipendente"
        />
      </div>

      <button
        type="button"
        (click)="loadTemplate()"
        class="btn btn-primary"
        aria-label="Carica template per il mese selezionato"
      >
        Carica Template Mese
      </button>
    </div>
  </section>

  <section
    *ngIf="getCurrentMonthHolidays().length > 0"
    class="holidays-info feature-card"
    aria-labelledby="holidays-heading"
  >
    <div class="section-header">
      <div class="section-title">
        <h3 id="holidays-heading">Festivit√† del Mese</h3>
      </div>
    </div>
    <div class="holidays-list">
      <div
        *ngFor="let holiday of getCurrentMonthHolidays()"
        class="holiday-item"
      >
        <span class="holiday-date">{{ formatHolidayDate(holiday.date) }}</span>
        <span class="holiday-description">{{ holiday.reason }}</span>
        <button
          class="btn btn-danger btn-sm"
          (click)="removeHoliday(holiday.date)"
          aria-label="Rimuovi festivit√†"
        >
          Rimuovi
        </button>
      </div>
    </div>
    <div class="manage-holidays">
      <button class="btn btn-outline" (click)="toggleHolidayManager()">
        Gestisci festivit√†
      </button>
      <div
        *ngIf="showHolidayManager()"
        class="form-inline"
        style="margin-top: 8px"
      >
        <input
          id="holiday-date"
          type="date"
          [ngModel]="holidayDateModel()"
          (ngModelChange)="holidayDateModel.set($event)"
          class="form-control"
          aria-label="Data festivit√†"
        />
        <input
          [ngModel]="holidayReasonModel()"
          (ngModelChange)="holidayReasonModel.set($event)"
          placeholder="Motivo (es. Chiusura azienda)"
          class="form-control"
          aria-label="Motivo festivit√†"
        />
        <button
          class="btn btn-secondary"
          (click)="
            addHoliday(holidayDateModel(), holidayReasonModel());
            holidayDateModel.set('');
            holidayReasonModel.set('')
          "
        >
          Aggiungi festivit√†
        </button>
      </div>
    </div>
  </section>

  <section class="summary-section" aria-labelledby="summary-heading">
    <app-report-summary
      [employeeName]="employeeName()"
      [currentMonth]="currentMonth()"
      [totalWorkDays]="totalWorkDays()"
      [totalDeclaredDays]="totalDeclaredDays()"
      [quadrature]="quadrature()"
      [overtime]="overtime()"
      [activityTotals]="activityTotals()"
      [activityDays]="activityDays()"
      [activityCodes]="activityCodes()"
    >
    </app-report-summary>
  </section>

  <section
    class="entries-section feature-card"
    aria-labelledby="entries-heading"
  >
    <div class="section-header">
      <div class="section-title">
        <span class="feature-icon" aria-hidden="true">üìù</span>
        <h3 id="entries-heading">Dettaglio Giornaliero</h3>
      </div>
      <button
        type="button"
        (click)="addDayEntry()"
        class="btn btn-primary"
        aria-label="Aggiungi un nuovo giorno al report"
      >
        ‚ûï Aggiungi Giorno
      </button>
    </div>

    @if (hasExceededDailyLimit()) {
    <div class="alert alert-warning" role="alert" aria-live="polite">
      <span class="warning-icon" aria-hidden="true">‚ö†Ô∏è</span>
      <div class="warning-content">
        <strong>Attenzione:</strong> Alcuni giorni superano il limite di 8 ore.
        <div class="exceeded-days">
          @for (day of getExceededDays(); track day.date) {
          <div class="exceeded-day">
            {{ day.date | date : "dd/MM/yyyy" }}: {{ day.hours }} ore
          </div>
          }
        </div>
      </div>
    </div>
    }

    <div class="entries-container">
      @for (day of days(); track day.date.getTime(); let i = $index) {
      <app-day-entry
        [day]="day"
        [index]="i"
        [activityCodes]="activityCodes()"
        [extracts]="extracts()"
        [dailyHours]="getDailyHoursForDate(day.date)"
        (update)="updateDayEntry($event)"
        (remove)="removeDayEntry($event)"
        role="row"
      >
      </app-day-entry>
      } @if (days().length === 0) {
      <div class="no-entries" aria-live="polite">
        <div class="no-entries-icon" aria-hidden="true">üìÖ</div>
        <h4>Nessun giorno inserito</h4>
        <p>
          Clicca "Carica Template Mese" per iniziare o "Aggiungi Giorno" per
          inserire manualmente.
        </p>
      </div>
      }
    </div>
  </section>
  <section class="export-section feature-card" aria-labelledby="export-heading">
    <div class="export-content">
      <h3 id="export-heading">Esporta Report</h3>
      <p>Genera il file Excel completo per l'invio all'amministrazione</p>

      <button
        type="button"
        (click)="exportToExcel()"
        class="btn btn-export"
        [disabled]="
          !allDaysValid() || days().length === 0 || !isMonthFullyFilled()
        "
        aria-describedby="export-requirements"
        aria-label="Esporta il report in formato Excel"
      >
        üöÄ Esporta in Excel
      </button>

      <p class="export-note">
        Il prospetto dovr√† essere inviato entro la chiusura del mese all'Ufficio
        Amministrazione:
        <a
          href="mailto:amministrazione@beyondoc.net"
          aria-label="Invia email a amministrazione@beyondoc.net"
        >
          {{ "amministrazione@beyondoc.net" }}
        </a>
      </p>

      <div id="export-requirements" class="visually-hidden">
        Per esportare, √® necessario che tutti i giorni siano validi, ci sia
        almeno un giorno inserito e il mese sia completamente compilato.
      </div>

      @if (days().length > 0 && !allDaysValid()) {
      <div class="validation-warning" role="alert" aria-live="polite">
        <span class="warning-icon" aria-hidden="true">‚ö†Ô∏è</span>
        <div>
          <strong>Completa tutti i campi obbligatori:</strong>
          <ul>
            <li>Codice attivit√† selezionato per ogni giorno</li>
            <li>Ore comprese tra 1 e 8 per ogni voce</li>
            <li>Non pi√π di 8 ore totali per giorno</li>
          </ul>
        </div>
      </div>
      } @if (days().length > 0 && !isMonthFullyFilled()) {
      <div class="validation-warning" role="alert" aria-live="polite">
        <span class="warning-icon" aria-hidden="true">‚ö†Ô∏è</span>
        <div>
          <strong>Mese non completamente compilato:</strong>
          <ul>
            <li>
              Assicurati di aver inserito esattamente 8 ore per ogni giorno
              lavorativo del mese
            </li>
            <li>Giorni lavorativi totali: {{ totalWorkDays() }}</li>
            <li>Giorni dichiarati: {{ totalDeclaredDays() }}</li>
            @if (getCurrentMonthHolidays().length > 0) {
            <li>
              Festivit√† considerate: {{ getCurrentMonthHolidays().length }}
            </li>
            }
          </ul>
        </div>
      </div>
      }
    </div>
  </section>
</div>
